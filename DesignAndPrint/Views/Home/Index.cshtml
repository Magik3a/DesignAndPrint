@{
    ViewBag.Title = "Home Page";
}
@*<script src="~/Scripts/kendo/2016.2.714/kendo.all.min.intellisense.js"></script>*@
<div>
    <img src="~/Images/accent.png" id="imgOriginal" />
</div>

<div class="row">
    <button type="button" class="btn btn-warning btn-lg" data-toggle="modal" data-target=".templates-modal">
        Choose different template
    </button>

      <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target=".add-to-all-modal">
        Add picture to all boxes
    </button>
</div>
<div class="row content-placeholders" id="page-for-printing">
    @for (var i = 0; i < 10; i++)
    {
        <div class="placeholder">
            <div class="panel panel-default box" onmousedown="AddImageToPlaceHolder(this)">
                <div class="panel-body text-center">
                    <a href='#' class='btn btn-success btn-add-image' style="display: none;" data-toggle="modal" data-target=".add-picture-modal">Add image </a>
                </div>
            </div>
        </div>
    }
</div>
<hr />
<div class="row">
    <button class="btn btn-danger" id="print-button">
        Print
    </button>
</div>


@Html.Partial("ModalTemplates/TemplatesModal")

@Html.Partial("ModalTemplates/AddPictureToPlaceModal")

@Html.Partial("ModalTemplates/AddPictureToAllPlacesModal")


@section Scripts{


    <script src="~/Scripts/jquery.browser.min.js"></script>
    <script src="~/Scripts/jquery.printelement.min.js"></script>
    <script src="~/Scripts/clickevents.js"></script>
    <script src="~/Scripts/ajx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/2.3.2/cropper.min.js"></script>


    <script>
        var ImageCropper = {
            config: {
                cropX: 0,
                cropY: 0,
                cropHeight: 0,
                cropWidth: 0
            },
            init: function () {
                this.BindEvents();
            },
            BindEvents: function () {
                $('.btnCrop').on('click', function () {
                    var objImage = $('#image').cropper('getCropBoxData');
                    ImageCropper.Crop(objImage);
                });
                $('.btnCropAndAddToAll').on('click', function () {
                    var objImage = $('#imageForAll').cropper('getCropBoxData');
                    ImageCropper.CropForAll(objImage);
                });


                
            },
            InitCrop: function () {
                //initialize the cropper method
                $('#image').cropper({
                    aspectRatio: 16 / 9,
                    dragMode: 'move', //enabling dragging of image
                    center: true,
                    autoCrop: true, //use this to just zoom and pan image around
                    autoCropArea: 0.3, //the size of the crop box
                    zoomable: true,
                    zoomOnWheel: true,
                    crop: function (e) {
                        // Output the result data for cropping image.
                        ImageCropper.SetSizeandCoordinates(e);
                    }
                });

            },

             InitCropForAll: function () {
                //initialize the cropper method
                $('#imageForAll').cropper({
                    aspectRatio: 16 / 9,
                    dragMode: 'move', //enabling dragging of image
                    center: true,
                    autoCrop: true, //use this to just zoom and pan image around
                    autoCropArea: 0.3, //the size of the crop box
                    zoomable: true,
                    zoomOnWheel: true,
                    crop: function (e) {
                        // Output the result data for cropping image.
                        ImageCropper.SetSizeandCoordinates(e);
                    }
                });

             },

            SetSizeandCoordinates: function (e) {
                ImageCropper.config.cropX = e.x;
                ImageCropper.config.cropY = e.y;
                ImageCropper.config.cropHeight = e.height;
                ImageCropper.config.cropWidth = e.width;
            },
            Crop: function () {
                var param = {
                    imagePath: $('#image').attr("src").split("?")[0],
                    cropPointX: ImageCropper.config.cropX,
                    cropPointY: ImageCropper.config.cropY,
                    imageCropWidth: ImageCropper.config.cropWidth,
                    imageCropHeight: ImageCropper.config.cropHeight
                };
                ajx.invoke('/Home/CropImage', JSON.stringify(param), function (data) {
                    //can refresh the image path in the original location
                    //destroy the crop instance
                    $('#image').cropper('destroy');
                    //replace the original image with new image
                    //timestamp is used to avoid caching
                    //$('.active-box').attr("style","background-image: url("+ data.photoPath + "?t=" + new Date().getTime()+")");

                    var img = $('.active-box .panel-body img').length;
                    if (img) {
                        $('.active-box .panel-body img').remove();
                    }
                    $('.active-box .panel-body').append("<img src='" + data.photoPath +"?t=" + new Date().getTime() +"' style='width: 100%; height: 100%; float: left;' />");
                    $(".k-upload ").show();
                          $('#image').attr("src", "");
                      $('#image').hide();
                     $('.add-picture-modal').modal('toggle');
                });
            },
            CropForAll: function () {
                 var param = {
                    imagePath: $('#imageForAll').attr("src").split("?")[0],
                    cropPointX: ImageCropper.config.cropX,
                    cropPointY: ImageCropper.config.cropY,
                    imageCropWidth: ImageCropper.config.cropWidth,
                    imageCropHeight: ImageCropper.config.cropHeight
                 };


                  ajx.invoke('/Home/CropImage', JSON.stringify(param), function (data) {
                    //can refresh the image path in the original location
                    //destroy the crop instance
                    $('#imageForAll').cropper('destroy');
                    //replace the original image with new image
                    //timestamp is used to avoid caching
                    //$('.active-box').attr("style","background-image: url("+ data.photoPath + "?t=" + new Date().getTime()+")");
                    $(".box").each(function (index, element) {
                        var img = $(element).children(".panel-body").children("img").length;
                        console.log(img > 0);
                            if (img) {
                                $(element).children(".panel-body").children("img").remove();
                                console.log("have image");
                            }

                            $(element).children(".panel-body").append("<img src='" + data.photoPath + "?t=" + new Date().getTime() + "' style='width: 100%; height: 100%; float: left;' />");
                                           console.log("appended image");
                    });
                  
                    
                    $(".k-upload ").show();
                      $('#imageForAll').attr("src", "");
                      $('#imageForAll').hide();
                     $('.add-to-all-modal').modal('toggle');
                });
            }
        };

        function onSuccess(e) {
            // Array with information about the uploaded files

            if (e.operation == "upload" && e.response.cutforall) {
               var imagePath =  "../Uploads/" + e.response.filename;
                            console.log(e.response.cutforall);
               $(".k-upload-files").remove();
                $(".k-upload ").hide();
                console.log(imagePath);
                $('#imageForAll').attr("src", imagePath);
                $('#imageForAll').show();
                
                ImageCropper.InitCropForAll();
                return;
            }
             if (e.operation == "upload") {
                var imagePath =  "../Uploads/" + e.response.filename;

               $(".k-upload-files").remove();
                $(".k-upload ").hide();
                console.log(imagePath);
                $('#image').attr("src", imagePath);
                $('#image').show();
                
                 ImageCropper.InitCrop();
            }
        };

        function getFileInfo(e) {
            return $.map(e.files, function (file) {
                var info = file.name;

                return info;
            }).join(", ");
        };
        $(document).ready(function () {
            ImageCropper.init();
        });
    </script>

}
